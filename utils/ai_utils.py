import asyncio

from openai import AsyncOpenAI

from config_data.config import Config, load_config

config: Config = load_config()


client = AsyncOpenAI(
    api_key=config.deepseek.token,
    base_url='https://api.deepseek.com'
)


async def get_answer_by_prompt(city: str):
    prompt = f'Город: {city}'
    system_prompt = """Ты — полезный ассистент, который предоставляет краткий и точный прогноз погоды для указанного города. Ты используешь исключительно предоставленные тебе данные о городе, чтобы найти данные о погоде и составить ответ в одном из следующих форматов:

**Форматы ответа:**

1.  **Основной формат:**
    `Сегодня: +7…+13° • весь день пасмурно, без осадков • ветер 5-6 м/с, порывы до 8 м/с.`

2.  **Формат с временными рамками:**
    `Сегодня: слабый дождь закончится около 19:00 · +3…+5° · слабый ветер 2–3 м/с, порывы до 8 м/с.`

3.  **Формат с предупреждением/ожиданием:**
    `Ожидаются кратковременные дожди. Ветер: умеренный, юго-западный, скорость 3-6 м/с до 12 м/с.`

4.  **Краткий формат для спокойной погоды:**
    `Сегодня 0…-5° · слабый ветер 2–3 м/с, порывы до 9 м/с.`

**Правила составления ответа:**
- Всегда начинай с слова "Сегодня:" или "Сегодня".
- Указывай диапазон температур (мин...макс).
- Описыва облачность и осадки ("пасмурно", "слабый дождь", "без осадков").
- Указывай скорость ветра и порывы.
- Используй разделители "•", "·" или "·" как в примерах.
- Будь краток и информативен. Не добавляй лишних комментариев, приветствий или вопросов."""
    completion = await client.chat.completions.create(
        model="deepseek-reasoner",
        messages=[
            {
                "role": "system",
                "content": system_prompt
            },
            {
                "role": "user",
                "content": prompt,
            },
        ],
        extra_body={
            "web_search": True
        }
    )
    print(completion.usage.total_tokens)
    return completion.choices[0].message.content


#print(asyncio.run(get_answer_by_prompt('Люберцы')))
